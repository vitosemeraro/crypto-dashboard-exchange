<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto KPI â€“ SOL/USDC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 24px; }
    .metric { padding: 12px 16px; border-radius: 12px; background:#fafafa; box-shadow: 0 1px 3px rgba(0,0,0,.06);}
    .grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:16px; }
    .muted { color:#666; font-size:.9rem; }
    .table thead th { position: sticky; top:0; background:#fff; }
  </style>
  <script>
    function setSixMonthsRange() {
      const end = new Date();
      const start = new Date();
      start.setMonth(end.getMonth() - 6);
      document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
      document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    }
  </script>
</head>
<body>
  <h2>ðŸ“ˆ Crypto KPI Dashboard â€“ {{ pair }}</h2>

  <form class="row g-3 mt-3" method="post" action="/calc">
    <div class="col-auto">
      <label class="form-label">Inizio (UTC)</label>
      <input type="date" class="form-control" name="start_date" value="{{ start }}" required>
    </div>
    <div class="col-auto">
      <label class="form-label">Fine (UTC)</label>
      <input type="date" class="form-control" name="end_date" value="{{ end }}" required>
    </div>
    <div class="col-auto align-self-end">
      <button type="button" class="btn btn-outline-secondary" onclick="setSixMonthsRange()"><div class="col-auto align-self-end">
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="
    const end = new Date();
    const start = new Date(end);
    start.setMonth(end.getMonth() - 6);
    document.querySelector('input[name=start_date]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name=end_date]').value = end.toISOString().split('T')[0];
  ">Ultimi 6 mesi</button>
</div>
 6 mesi</button>
    </div>
    <div class="w-100"></div>
    <div class="col-auto">
      <label class="form-label">Qty residua</label>
      <input type="number" step="0.01" class="form-control" name="res_qty" value="15">
    </div>
    <div class="col-auto">
      <label class="form-label">Prezzo medio residuo</label>
      <input type="number" step="0.01" class="form-control" name="res_avg" value="201">
    </div>
    <div class="col-auto">
      <label class="form-label">Target residuo</label>
      <input type="number" step="0.01" class="form-control" name="res_target" value="220">
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-primary">Calcola KPI</button>
    </div>
  </form>

  {% if error %}
    <div class="alert alert-danger mt-4">{{ error }}</div>
  {% endif %}

  {% if result %}
    <hr class="my-4" />
    <div class="row">
      <div class="col-md-6"><div class="metric">
        <div class="muted">Data inizio</div>
        <div><strong>{{ result.period.start.strftime('%d/%m/%Y %H:%M') if result.period.start else '-' }}</strong></div>
      </div></div>
      <div class="col-md-6"><div class="metric">
        <div class="muted">Data fine</div>
        <div><strong>{{ result.period.end.strftime('%d/%m/%Y %H:%M') if result.period.end else '-' }}</strong></div>
      </div></div>
    </div>

    <div class="grid mt-3">
      <div class="metric">
        <div class="muted">PNL totale (con residuo)</div>
        <div><strong>{{ fmt(result.pnl.totalWithResidual) }} USDC</strong></div>
        <div class="muted mt-1">Numero di trade: <strong>{{ result.counts.trades }}</strong></div>
        <div class="muted">Success rate: <strong>{{ fmt(result.counts.successRatePct) }}%</strong></div>
      </div>
      <div class="metric">
        <div class="muted">Totale USDC mossi</div>
        <div><strong>{{ fmt(result.sizes.totalUSDCMoved) }} USDC</strong></div>
        <div class="muted mt-1">Guadagno mensile medio: <strong>{{ fmt(result.monthlyAvgGain) }} USDC</strong></div>
        <div class="muted">PNL medio per trade: <strong>{{ fmt(result.perTrade.avgPnl) }} USDC</strong></div>
        <div class="muted">Valore residuo a target: <strong>{{ fmt(result.pnl.residual.value) }} USDC</strong></div>
      </div>
      <div class="metric">
        <div class="muted">Size media per trade</div>
        <div><strong>{{ fmt(result.sizes.avgTradeUSDC) }} USDC</strong></div>
        <div class="muted mt-1">Durata media trade: <strong>{{ fmt_duration(result.perTrade.avgDurationMin) }}</strong></div>
        <div class="muted">PNL totale (senza residuo): <strong>{{ fmt(result.pnl.total) }} USDC</strong></div>
      </div>
    </div>

    <p class="muted mt-2">Residuo: {{ result.pnl.residual.qty|int }} SOL @ {{ fmt(result.pnl.residual.avgCost) }} â†’ target {{ fmt(result.pnl.residual.targetPrice) }} | PnL residuo: {{ fmt(result.pnl.residual.pnl) }} USDC</p>

    <hr class="my-4" />

    <div class="row">
      <div class="col-md-6">
        <h5>ðŸ¥‡ Miglior trade</h5>
        {% if result.bestTrade %}
          <p>PnL: <strong>{{ fmt(result.bestTrade.pnl) }} USDC</strong> | Size: {{ fmt(result.bestTrade.size_usdc) }} USDC</p>
          <p>Buy: {{ result.bestTrade.buy_date.strftime('%d/%m/%Y %H:%M') }} â†’ Sell: {{ result.bestTrade.sell_date.strftime('%d/%m/%Y %H:%M') }}</p>
          <p>Durata: {{ fmt_duration(result.bestTrade.dur_min) }}</p>
        {% else %}<p>-</p>{% endif %}
      </div>
      <div class="col-md-6">
        <h5>ðŸ¥¶ Peggior trade</h5>
        {% if result.worstTrade %}
          <p>PnL: <strong>{{ fmt(result.worstTrade.pnl) }} USDC</strong> | Size: {{ fmt(result.worstTrade.size_usdc) }} USDC</p>
          <p>Buy: {{ result.worstTrade.buy_date.strftime('%d/%m/%Y %H:%M') }} â†’ Sell: {{ result.worstTrade.sell_date.strftime('%d/%m/%Y %H:%M') }}</p>
          <p>Durata: {{ fmt_duration(result.worstTrade.dur_min) }}</p>
        {% else %}<p>-</p>{% endif %}
      </div>
    </div>

    <hr class="my-4" />
    <h5>ðŸ“Œ Posizioni aperte (live)</h5>
    {% if inventory and inventory|length > 0 %}
      {% if live_price %}
        <p class="muted">Prezzo live {{ pair }}: <strong>{{ fmt(live_price) }} USDC</strong></p>
      {% endif %}
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr>
            <th>Data buy</th><th>Qty (SOL)</th><th>Prezzo medio</th><th>Valore live (USDC)</th><th>PnL live (USDC)</th><th>PnL live (%)</th>
          </tr></thead>
          <tbody>
          {% for b in inventory %}
            {% set val = (b.qty * (live_price or 0)) %}
            {% set cost = (b.qty * b.avg_cost) %}
            {% set pnl  = (val - cost - b.fee_usdc) %}
            {% set pnlp = (100.0 * pnl / cost) if cost > 0 else 0.0 %}
            <tr>
              <td>{{ b.date.strftime('%d/%m/%Y %H:%M') }}</td>
              <td>{{ fmt(b.qty) }}</td>
              <td>{{ fmt(b.avg_cost) }}</td>
              <td>{{ fmt(val) }}</td>
              <td>{{ fmt(pnl) }}</td>
              <td>{{ fmt(pnlp) }}%</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>- Nessuna posizione aperta.</p>
    {% endif %}
  {% endif %}
</body>
</html>
